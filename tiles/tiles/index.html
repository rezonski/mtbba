<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Interactive map of effects of Iran Nuclear Deal</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src="js/turf.min.js"></script>
    <script src="js/dragonfly-dev.js"></script>
    <link href="css/app.css" rel="stylesheet"/>
    <link href="css/dragonfly.css" rel="stylesheet"/>
</head>
<body>
    <div class="app-container">
        <div class="map-container">
            <div id="map" class="dragonfly-map"></div>
        </div>
        <div id="display-year"></div>
    </div>
    <script>
        var currentYear = '2000';
        var newYear = '';
        var mapStyle = {
            'version': 8,
            'glyphs': 'font/Arial%20Regular/0-255.pbf',
            'sprite': 'sprite/sprite',
            'sources': {
                'geobuffer': {
                'type': 'vector',
                'tiles': [
                    'https://tiles3.socialexplorer.com/gettile/?x={x}&y={y}&z={z}&layers={layers}&projection=EPSG-3857&columns={columns}'
                ],
                'layers': [
                    // STATES
                    {
                        'layerId': '16891',
                        'datasets': [
                            {
                                'datasetId': 0,
                                'columns': [
                                    'ISO',
                                    'ID_1',
                                    'NAME_1'
                                ]
                            }
                        ]
                    },
                    {
                        'layerId': '16891p',
                        'datasets': [
                            {
                                'datasetId': 0,
                                'columns': [
                                    'ISO',
                                    'ID_1',
                                    'NAME_1'
                                ]
                            }
                        ]
                    },
                ]
            },
                'rasterSource': {
                    'type': 'raster',
                    'tiles': ['http://wpc.4693.edgecastcdn.net/004693/tiles/area/' + currentYear + '/Z{z}/{y}/{x}.png?v=20'],
                    'tileSize': 256
                }
            },
            'layers': [
                {
                    'id': 'background',
                    'type': 'background',
                    'paint': {
                        'background-color': '#fff'
                    }
                },
                {
                    'id': 'history-tiles',
                    'type': 'raster',
                    'source': 'rasterSource',
                    'minzoom': 0,
                    'maxzoom': 7
                },
                {
                    'id': 'dummy',
                    'type': 'background',
                    'paint': {
                        'background-color': 'rgba(0,0,0,0)'
                    }
                },
                {
                    'id': 'features',
                    'type': 'fill',
                    'source': 'geobuffer',
                    'source-layer': '16891',
                    'paint': {
                        'fill-color': 'rgba(0,0,0,0.1)'
                    }
                },
                {
                    'id': 'selected',
                    'type': 'fill',
                    'source': 'geobuffer',
                    'source-layer': '16891',
                    'paint': {
                        'fill-color': '#C369C3'
                    },
                    'filter': ['in', 'ID_1', 0]
                },
                {
                    'id': 'boundaries',
                    'type': 'line',
                    'source': 'geobuffer',
                    'source-layer': '16891',
                    'paint': {
                        'line-color': 'rgba(0, 0, 0, 0.2)',
                        'line-width': 1,
                        'line-blur': 1
                    }
                },
                {
                    'id': 'labels',
                    'type': 'symbol',
                    'source': 'geobuffer',
                    'source-layer': '16891p',
                    'paint': {
                        'text-color': 'rgba(0, 0, 0, 0.7)',
                        'text-halo-color': 'rgba(255, 255, 255, 0.8)',
                        'text-halo-width': 1,
                        'text-halo-blur': 1
                    },
                    'layout': {
                        'text-field': '{ISO}',
                        'text-offset': [0, 1.1],
                        'text-size': {
                            'stops': [[4,9],[22,15]]
                        },
                    }
                },
            ]
        };
        var map = new dragonfly.Map({
            container: 'map',
            style: mapStyle,
            // maxBounds: [[-250,-90],[250,90]]
            center: [0, 0],
            zoom: 1,
            maxZoom: 6
            // pitch: 50,
            // bearing: -10,
        });
        map.boxZoom.disable();
        map.on('load', function () {
            map.fitBounds([[-180,-63],[180,80]]);
            var canvas = map.getCanvasContainer();
            var start;
            var current;
            var box;
            canvas.addEventListener('mousedown', mouseDown, true);
            // Return the xy coordinates of the mouse position
            function mousePos(e) {
                var rect = canvas.getBoundingClientRect();
                return new dragonfly.Point(
                    e.clientX - rect.left - canvas.clientLeft,
                    e.clientY - rect.top - canvas.clientTop
                );
            }

            function mouseDown(e) {
                // Continue the rest of the function if the shiftkey is pressed.
                if (!(e.shiftKey && e.button === 0)) return;
                // Disable default drag zooming when the shift key is held down.
                map.dragPan.disable();
                // Call functions for the following events
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
                document.addEventListener('keydown', onKeyDown);
                // Capture the first xy coordinates
                start = mousePos(e);
            }

            function onMouseMove(e) {
                // Capture the ongoing xy coordinates
                current = mousePos(e);

                // Append the box element if it doesnt exist
                if (!box) {
                    box = document.createElement('div');
                    box.classList.add('boxdraw');
                    canvas.appendChild(box);
                }

                var minX = Math.min(start.x, current.x),
                    maxX = Math.max(start.x, current.x),
                    minY = Math.min(start.y, current.y),
                    maxY = Math.max(start.y, current.y);

                // Adjust width and xy position of the box element ongoing
                var pos = 'translate(' + minX + 'px,' + minY + 'px)';
                box.style.transform = pos;
                box.style.WebkitTransform = pos;
                box.style.width = maxX - minX + 'px';
                box.style.height = maxY - minY + 'px';
            }
            
            function onMouseUp(e) {
                // Capture xy coordinates
                finish([start, mousePos(e)]);
            }

            function onKeyDown(e) {
                // If the ESC key is pressed
                if (e.keyCode === 27) finish();
            }

            function finish(bbox) {
                // Remove these events now that finish has been called.
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('keydown', onKeyDown);
                document.removeEventListener('mouseup', onMouseUp);

                if (box) {
                    box.parentNode.removeChild(box);
                    box = null;
                }

                // If bbox exists. use this value as the argument for `queryRenderedFeatures`
                if (bbox) {
                    var features = map.queryRenderedFeatures(bbox, { layers: ['features'] });

                    if (features.length >= 1000) {
                        return window.alert('Select a smaller number of features');
                    }

                    // Run through the selected features and set a filter
                    // to match features with unique FIPS codes to activate
                    // the `counties-highlighted` layer.
                    var filter = features.reduce(function(memo, feature) {
                        memo.push(feature.properties.ID_1);
                        return memo;
                    }, ['in', 'ID_1']);

                    map.setFilter('selected', filter);
                }

                map.dragPan.enable();
            }

            map.on('mousemove', function(e) {
                var features = map.queryRenderedFeatures(e.point, { layers: ['counties-highlighted'] });
                // Change the cursor style as a UI indicator.
                map.getCanvas().style.cursor = (features.length) ? 'pointer' : '';
                var feature = features[0];
            });

        });
        map.on('zoom', function () {
            // console.info(map.getZoom());
        });
        window.onkeydown = function (e) {
            console.info(e.keyCode);
            console.info(String.fromCharCode(e.keyCode));
            if (e.keyCode == 27 || e.keyCode == 89) {
                console.info('Reset newYear');
                newYear = '';
            } else if (newYear != currentYear && newYear.length == 4 && e.keyCode == 13) {
                console.info('Set tiles to ' + newYear);
                if (map.getSource('rasterSource')) {
                    map.removeLayer('history-tiles');
                    map.removeSource('rasterSource');
                    map.addSource('rasterSource', {
                        'type': 'raster',
                        'tiles': ['http://wpc.4693.edgecastcdn.net/004693/tiles/area/' + newYear + '/Z{z}/{y}/{x}.png?v=20'],
                        'tileSize': 256
                    });
                    map.addLayer({
                        'id': 'history-tiles',
                        'type': 'raster',
                        'source': 'rasterSource',
                        'minzoom': 0,
                        'maxzoom': 7
                    }, 'dummy');
                    currentYear = parseInt(newYear, 10);
                }
            } else if (Number.isInteger(parseInt(String.fromCharCode(e.keyCode), 10)) && newYear.length < 4) {
                console.info(newYear + ' + '+ String.fromCharCode(e.keyCode));
                newYear += String.fromCharCode(e.keyCode);
            } else {
                console.info('Invalid input');
            }
            document.getElementById('display-year').innerHTML = newYear;
        };
    </script>
</body>
</html>