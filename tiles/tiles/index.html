<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Interactive map of effects of Iran Nuclear Deal</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src="js/turf.min.js"></script>
    <script src="js/dragonfly-dev.js"></script>
    <script src="js/mapDefinition.js"></script>
    <script src="js/editablegrid.js"></script>
    <script src="js/editablegrid_renderers.js" ></script>
    <script src="js/editablegrid_editors.js" ></script>
    <script src="js/editablegrid_validators.js" ></script>
    <script src="js/editablegrid_utils.js" ></script>
    <script src="js/editablegrid_charts.js" ></script>
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="css/editablegrid.css" type="text/css" media="screen">
    <link href="css/app.css" rel="stylesheet"/>
    <link href="css/dragonfly.css" rel="stylesheet"/>
</head>
<body>
    <div class="app-container">
        <div class="map-container">
            <div id="map" class="dragonfly-map"></div>
        </div>
        <div id="table-container" class="table-container">
            <div id="tablecontent"></div>
        </div>
        <div class="data-maniputlation controls">
            <button onclick="resetMapTable()">Deselect selected features</button>
            <label for="isos"> Set ISOs: </label>
            <input id="isos">
            <label for="colonies"> Set Colony: </label>
            <input id="colonies">
        </div>
        <div class="year-switch controls">
            <input type="number" id="currentYear" name="currentYear" value="2010">
            <button onclick="setYear()">Set year</button>
        </div>
    </div>
    <script>
        var currentYear = 2010;
        var selectedUIDs = [];
        
        var map = new dragonfly.Map({
            container: 'map',
            style: mapStyle,
            // maxBounds: [[-250,-90],[250,90]]
            center: [0, 0],
            zoom: 1,
            maxZoom: 6
            // pitch: 50,
            // bearing: -10,
        });
        map.boxZoom.disable();

        function setYear() {
            var newYear = parseInt(document.getElementById('currentYear').value, 10);
            if (currentYear !== newYear) {
                console.info('Set tiles to ' + newYear);
                if (map.getSource('rasterSource')) {
                    map.removeLayer('history-tiles');
                    map.removeSource('rasterSource');
                    map.addSource('rasterSource', {
                        'type': 'raster',
                        'tiles': ['http://wpc.4693.edgecastcdn.net/004693/tiles/area/' + newYear + '/Z{z}/{y}/{x}.png?v=20'],
                        'tileSize': 256
                    });
                    map.addLayer({
                        'id': 'history-tiles',
                        'type': 'raster',
                        'source': 'rasterSource',
                        'minzoom': 0,
                        'maxzoom': 7
                    }, 'dummy');
                    currentYear = parseInt(newYear, 10);
                }
            }
        }

        function resetMapTable() {
            selectedUIDs.forEach(id => {
                document.getElementById('DemoGridJSON_' + id).style['background-color'] = null;
            });
            document.getElementById('tablecontent').style.top = '0px';
            selectedUIDs = [];
            map.setFilter('hovered', ['in', 'UID', 0]);
        }
        
        map.on('load', function () {
            map.fitBounds([[-180,-63],[180,80]]);
            var canvas = map.getCanvasContainer();
            var start;
            var current;
            var box;
            canvas.addEventListener('mousedown', mouseDown, true);
            // Return the xy coordinates of the mouse position
            function mousePos(e) {
                var rect = canvas.getBoundingClientRect();
                return new dragonfly.Point(
                    e.clientX - rect.left - canvas.clientLeft,
                    e.clientY - rect.top - canvas.clientTop
                );
            }

            function mouseDown(e) {
                // Continue the rest of the function if the shiftkey is pressed.
                if (!(e.shiftKey && e.button === 0)) return;
                // Disable default drag zooming when the shift key is held down.
                map.dragPan.disable();
                // Call functions for the following events
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
                document.addEventListener('keydown', onKeyDown);
                // Capture the first xy coordinates
                start = mousePos(e);
            }

            function onMouseMove(e) {
                // Capture the ongoing xy coordinates
                current = mousePos(e);

                // Append the box element if it doesnt exist
                if (!box) {
                    box = document.createElement('div');
                    box.classList.add('boxdraw');
                    canvas.appendChild(box);
                }

                var minX = Math.min(start.x, current.x),
                    maxX = Math.max(start.x, current.x),
                    minY = Math.min(start.y, current.y),
                    maxY = Math.max(start.y, current.y);

                // Adjust width and xy position of the box element ongoing
                var pos = 'translate(' + minX + 'px,' + minY + 'px)';
                box.style.transform = pos;
                box.style.WebkitTransform = pos;
                box.style.width = maxX - minX + 'px';
                box.style.height = maxY - minY + 'px';
            }
            
            function onMouseUp(e) {
                // Capture xy coordinates
                finish([start, mousePos(e)]);
            }

            function onKeyDown(e) {
                // If the ESC key is pressed
                if (e.keyCode === 27) finish();
            }

            function finish(bbox) {
                // Remove these events now that finish has been called.
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('keydown', onKeyDown);
                document.removeEventListener('mouseup', onMouseUp);

                if (box) {
                    box.parentNode.removeChild(box);
                    box = null;
                }

                // If bbox exists. use this value as the argument for `queryRenderedFeatures`
                if (bbox) {
                    var features = map.queryRenderedFeatures(bbox, { layers: ['features'] });
                    if (features.length >= 1000) {
                        return window.alert('Select a smaller number of features');
                    } else if (features.length > 0) {
                        document.getElementById('tablecontent').style.top = '0px';
                        features.forEach(feature => {
                            if (selectedUIDs.indexOf(feature.properties.UID) < 0) {
                                selectedUIDs.push(parseInt(feature.properties.UID, 10));
                                document.getElementById('DemoGridJSON_' + feature.properties.UID).style['background-color'] = '#F4FF00';
                            } else {
                                selectedUIDs.splice(selectedUIDs.indexOf(feature.properties.UID), 1);
                                document.getElementById('DemoGridJSON_' + feature.properties.UID).style['background-color'] = null;
                            }
                        });
                        map.setFilter('hovered', ['in', 'UID', ...selectedUIDs]);
                        var topOffset = document.getElementById('DemoGridJSON_' + selectedUIDs[selectedUIDs.length - 1]).getBoundingClientRect().top;
                        document.getElementById('tablecontent').style.top = (-1 * (topOffset - 200)) + 'px';
                    }
                }
                map.dragPan.enable();
            }

            function setUnsetUID(uid) {
                console.log('setUnsetUID(' + uid + ')');
                if (selectedUIDs.indexOf(uid) < 0) {
                    selectedUIDs.push(parseInt(uid, 10));
                    map.setFilter('hovered', ['in', 'UID', ...selectedUIDs]);
                    document.getElementById('DemoGridJSON_' + uid).style['background-color'] = '#F4FF00';
                    scrollTable(uid);
                    
                } else {
                    selectedUIDs.splice(selectedUIDs.indexOf(uid), 1);
                    map.setFilter('hovered', ['in', 'UID', ...selectedUIDs]);
                    document.getElementById('DemoGridJSON_' + uid).style['background-color'] = null;
                    scrollTable(selectedUIDs[selectedUIDs.length - 1]);
                }
            }

            function scrollTable(uid) {
                if (uid) {
                    var topDiff = $('#DemoGridJSON_' + uid).offset().top - $('#tablecontent').position().top;
                    $('#table-container').animate({
                        scrollTop: topDiff - 50
                    }, 500);
                }
            }

            map.on('click', function(e) {
                var features = map.queryRenderedFeatures(e.point, { layers: ['features'] });
                if (features.length > 0) {
                    var feature = features[0];
                    setUnsetUID(feature.properties.UID);
                }
            });
        });

        function initAutocompleteValuePicker(data) {
            var availableTags = [];
            data.forEach(e => {
                if (availableTags.indexOf(e.columns[1]) < 0) {
                    availableTags.push(e.columns[1]);
                }
            });
            $( "#isos" ).autocomplete({
              source: availableTags
            });
            $( "#colonies" ).autocomplete({
              source: availableTags
            });
        }

        window.onload = function() {
            editableGrid = new EditableGrid("DemoGridJSON"); 
            editableGrid.tableLoaded = function() {
                this.renderGrid("tablecontent", "testgrid");
            };
            editableGrid.tableRendered = function() {
                console.log('tableRendered');
                initAutocompleteValuePicker(editableGrid.data);
            };
            editableGrid.loadJSON("data/data1962.json");
        }
    </script>
</body>
</html>